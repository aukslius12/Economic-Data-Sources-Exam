---
title: "EDS Egzaminas"
author: "Jurgis Samaitis"
date: "January 7, 2018"
output:
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# ---------
library(gh)
library(rjson)
library(dplyr)
library(stringr)
library(lubridate)
library(RCurl)
library(rvest)
library(tibble)
library(tidyr)
library(purrr)
library(ggplot2)
```

Funkcijù failo nuskaitymas.
```{r}
tryCatch(source(str_c(getwd(), "//funkcijos.R"), encoding = "ISO-8859-4"),
         error = source(file = file.choose()), encoding = "ISO-8859-4")
```

# 1-4 U¾duotys

Naudosiu GitHub API, kad gauèiau failù skaiciu ir tikslius pavadinimus.

```{r}
# Visos duomenù "saugyklos" (repository) sha1 kodas - jo reikalauja GitHub API, 
# norint gauti vidinius repository duomenis.
repo_sha <-
  gh(
    'GET /repos/:owner/:repo/contents/:path',
    owner = "vzemlys",
    repo = "eda_2017",
    path = ""
  )[2][1][[1]]$sha

# Failu metadata.
file_info <-
  gh(
    'GET /repos/:owner/:repo/git/trees/:sha',
    owner = "vzemlys",
    repo = "eda_2017",
    path = "data",
    sha = repo_sha
  )$tree

# Pavyzdys
head(file_info, 1)
```

####**1. Kiek i¹ viso yra failù?**

```{r}
length(file_info)
```

####**2. Kiek yra skirtingù vietù kuriose buvo kaupiami duomenys?**

Naudodamas metadata, i¹gaunu failù pavadinimus. Kadangi failo pavadinimas yra miestas_data, tai i¹gavês "miestas", galiu pasakyti kiek tokiù vietoviù buvo.
```{r}
# Failù pavadinimai.
file_path <- character()
for (i in 1:length(file_info)) {
  file_path[i] <- file_info[[i]]$path
}

# Miestù pavadinimai.
(file_cities <- str_match(file_path, "\\w*_") %>%
  unique() %>%
  str_sub(end = str_length(.) - 1))
```

####**3. Kokiu laikotarpiu buvo kaupiami duomenys?**

Dar karta pasinaudoju miestas_data formatu ir i¹gaunu dat±. Paverèiu i date format± ir gaunu pradinê ir galutinê datas.

```{r}
# Data i¹ failù vardù.
file_datetime <-
  str_match(file_path, "\\d{4}-\\d{2}-\\d{2}_\\d{2}:\\d{2}:\\d{2}") %>%
  unique() %>%
  ymd_hms(tz = Sys.timezone()) # Jeigu ¾mogus ne i¹ Lietuvos, jo problemos kad ne ta laiko zona u¾ra¹yta. :)

# Atsakymas i klausim±.
(file_datetime_range <- file_datetime %>%
    range())
```

####**4. Kokiu da¾niu buvo kaupiami duomenys? (Kiek kartù per par±? Kiek parù? Ar duomenys buvo kaupiami nuolatos be pertraukos?)**

#####**4. a) Kiek kartù per par±?**


```{r}
# Suskaièiuoja skirtumus tarp kiekvieno laiko tarpo.
time_differences <- vector()
for (i in (seq_along(file_datetime) - 1)){
  
  time_differences[i] <- as.numeric(difftime(file_datetime[i], file_datetime[i+1], units = "mins"))
}
time_differences %>% 
  tibble() %>%
  summarise("Vidurkis (min)" = mean(.), "Mediana (min)" = median(.))
```

24 kartus per par± pagal median±, vidutini¹kai truputìlç daugiau, nes yra praleistù datù.

#####**4. b) Kiek parù?**

Galutinì data - pradinì data.

```{r}
file_datetime_range[2] - file_datetime_range[1]
```

#####**4. c) Ar duomenys buvo kaupiami nuolatos, be pertraukos?**
  
Funkcija paleid¾ia atskir± cikl±, einanti ¹alia realiù valandù - jeigu ciklo skaièius neatitinka valandù skaièiaus (didinamo kas 1 valand±), vadinasi vienas periodas buvo praleistas.
```{r}
missingHours(file_datetime, warnings_print = T)
```

# 5-8 U¾duotys

####**5. Atsitiktinai pasirinkite vien± fail± i¹ Vilniaus.**

I¹ visù failù pavadinimù, sumatchinu tik Vilniù, tada atsitinktinai pasirenku 1.
```{r}
set.seed(1401445)

# Matchinimas ir samplinimas.
(file_random_path <- file_path %>%
    .[which(str_match(file_path, "\\w*_") == "vilnius_")] %>%
    sample(1))
```

Parsisiunèiu patç fail±.
```{r}
# GitHub url formatas.
file_random_url <-
  str_c(
    "https://raw.githubusercontent.com/vzemlys/eda_2017/master/data/",
    file_random_path
  )

file_random <- read_html(getURL(file_random_url))
```

####**6. ©iame faile bus HTML lentelìs. Kiekviena i¹ jù prasideda tagu \<table\> ir baigiasi tagu \<\\table\>. Kiek lenteliù yra ¹iame faile?**

I¹ viso lenteliù kurios yra \<table\> taguose yra 14-15~, taciau tik 10 i¹ jù yra informacija apie orus.
```{r}
# Viso lenteliù yra:
file_random %>%
  html_nodes(xpath = '//table')

# Lentelìs su duomenimis apie orus.
(file_random_nodes <- file_random %>%
    html_nodes(xpath = '//*[@class="weather_box"]//table'))
```

####**7. Pasirinkite tas lenteles kuriose yra orù prognozì vienai dienai. Para¹ykite kod± kuris sutvarko viena lentelê.**

####**8. Sujunkite visas lenteles i vien± lentelê ir sukurkite stulpelius kuriuose yra miestas ir laikas kada buvo nuskaityta to miesto orù prognozì.**

7-8 padariau kartu, idejês ç cikl±.
```{r}
file_random_raw <- file_random_nodes %>%
  html_table()

orai_table_final <- tibble()

# Sutvarko visas lenteles ir sudeda i vien±.
for (i in seq_along(file_random_raw)) {
  temp_tbl <- as.tibble(file_random_raw[[i]])
  temp_tbl_final <- temp_tbl %>%
    # Pa¹alina iconeliù stulpelç (debesuota, saulìta, etc.).
    select(-X2) %>%
    # Pervadina stulpelius atitinkamais pavadinimais.
    `colnames<-`(sapply(slice(., 2), enc2native)) %>%
    # Pa¹alina eilutê, kuri± naudojom pavadinimams sudìti.
    slice(3:n()) %>%
    # Prideda laiko ir datos eilutes.
    separate(Laikas, into = c("Pradzia", "Pabaiga"), sep = " - ") %>%
    mutate(Pradzia = as.integer(str_sub(Pradzia, end = 2)),
               Pabaiga = as.integer(str_sub(Pabaiga, end = 2)))
  
  orai_table_final <- rbind(orai_table_final, temp_tbl_final)
}

# Galutinì lentele.
orai_table_final %>% mutate(Miestas = "vilnius")
```

# 9-14 U¾duotys

####**9. Panaudokite parasyt± funkcij± vienam failui skaityti, nuskaityti visoms Vilniaus miesto prognozìms. Kiek eiluèiù yra gautoje galutinìje lentelìje?**

Naudojama funkcija yra (beveik) viskas kas buvo virsuj, sujungta i vien±.
```{r}
weather_vilnius <- getWeatherTable("Vilnius", file_path)
head(weather_vilnius)

# Eiluèiù gautoje lentelìje yra:
nrow(weather_vilnius)
```

####**10. Pritaikykite Vilniaus miesto duomenims nuskaityti skirt± funkcij± nuskaityti Kauno ir Klaipìdos duomenimis. Sudìkite visk± ç vien± lentelê. Kiek yra duomenu kiekvienam miestui?**

T± paèi± funkcij± naudoju kiekvienam miestui, po to apjungiu i vien±.

```{r}
# Kauno duomenys.
weather_kaunas <- getWeatherTable("kauNas", file_path)
nrow(weather_kaunas)

# Klaipedos duomenys.
weather_klaipeda <- getWeatherTable("kLaipeda", file_path)
nrow(weather_klaipeda)

# Bendrai.
weather_final <- rbind(weather_vilnius, weather_kaunas, weather_klaipeda)
head(weather_final)
```

####**11. Para¹ykite funkcij± kuri skaito Èiurlionio hidrometereologijos stoties duomenis.**

Beveik identi¹kas formatas prie¹ tai naudotai funkcijai (truputìlç trumpesnì). Nuo Èiulionio failù numetu nereikalingus simbolius su regexpr ir paverciu JSON formatu (fixJson).
```{r}
weather_ciurlionis <- getWeatherCiurlionis(file_path)
head(weather_ciurlionis)
```

####**12. Pritaikykite ¹i± funkcija nuskaityti visiems Èiurlionio stoties duomenims. Kokia yra vidutinì vidurdienio temperatþra duomenù fiksuotu laikotarpiu? Atsitiktinai pasirinkite 21 dienù laikotarpç. Suskaièiuokite vidutinê dienos ir nakties temperatur±.**

```{r}
# Vidutinì vidurdienio temperatþra.
weather_ciurlionis %>%
  filter(Hour == 12) %>%
  summarize(mean(Temp))

# Pasirenkame atsitiktinê dien± i¹ duomenù.
set.seed(1401445)
start_date <- sample(weather_ciurlionis$Date, 1)
end_date <- start_date + days(20)

# Pasirenkame duomenis. Dienos period± laikysiu nuo 8:00 iki 20:00, nakties - kas lieka.
weather_ciurlionis_dn <- weather_ciurlionis %>%
  filter((Date >= start_date) & (Date <= end_date)) %>%
  mutate(Hour = as.integer(Hour),
         `diena/naktis` = ifelse((Hour >= 8) & (Hour <= 20), "diena", "naktis"))

# Vidurkiai.
weather_ciurlionis_dn %>%
  group_by(`diena/naktis`) %>%
  summarize("Vidurkis" = mean(Temp))

```

####**13. Para¹ykite funkcij± kuri nubrì¾ia pasirinktos dienos, valandos ir vietos visas surinktas prognozes kaip laiko eilutê(s). Atsitiktinai pasirinkite dien±, valand± ir miest± bei nubre¾kite grafik±.**

```{r}
# Atsitiktinai pasirenka parametrus.
set.seed(1401445)
city_rnd <- sample(file_cities, 1)
date_rnd <- weather_final$Data %>% sample(1)
hour_rnd <- sample(0:23, 1)

# I¹filtruoja duomenis pagal miest±, dat± ir valand±.
weather_filter <- weather_final %>%
  filter(Miestas == city_rnd,
         Data == date_rnd,
         Pradzia <= hour_rnd,
         Pabaiga >= hour_rnd)

# Jeigu filtravimas nieko nerado, vadinasi pasirinkta valanda yra labai ankstus rytas (0-2 valanda).
if (nrow(weather_filter) == 0) {
weather_filter <- weather_final %>%
  filter(Miestas == city_rnd,
         Data == date_rnd,
         Pradzia >= 18,
         Pabaiga >= hour_rnd & Pabaiga < 10)
}

# Jeigu ir antras filtravimas nieko nerado, vadinasi pasirinkta valanda yra vìlus vakaras (22+ valanda).
if (nrow(weather_filter) == 0) {
weather_filter <- weather_final %>%
  filter(Miestas == city_rnd,
         Data == date_rnd,
         Pradzia <= hour_rnd & Pradzia >= 18,
         Pabaiga < 10)
}

# Paverèia temperatur± i skaièiù ir nupai¹o grafik±.
weather_filter %>%
  mutate(Temperatura = as.numeric(str_match(Temperatura,".\\d{1,2}"))) %>%
  ggplot() +
  geom_point(mapping = aes(Data, Temperatura), color = "blue", size = 2) +
  theme_minimal()

```


####**14. Pasirinkite atsitiktinai dien±, valand± ir nubre¾kite surinktù Vilniaus prognoziu grafik± bei atidìkite tos dienos ir valandos uzfiksuot± reali± temperatþr± is Èiurlionio stoties.**


```{r}
# Atsitiktinai parenka parametrus (be miesto).
set.seed(1401445)
date_rnd <- weather_final$Data %>% sample(1)
hour_rnd <- sample(0:23, 1)

# I¹filtruoja vilniaus duomenis, tokiu paèiu principu kaip ir 13 uzduotyje.
# NUO ÈIA KODAS KARTOJASI.

# I¹filtruoja duomenis pagal miest±, dat± ir valand±.
weather_filter <- weather_final %>%
  filter(Miestas == "vilnius",
         Data == date_rnd,
         Pradzia <= hour_rnd,
         Pabaiga >= hour_rnd)

# Jeigu filtravimas nieko nerado, vadinasi pasirinkta valanda yra labai ankstus rytas (0-2 valanda).
if (nrow(weather_filter) == 0) {
weather_filter <- weather_final %>%
  filter(Miestas == city_rnd,
         Data == date_rnd,
         Pradzia >= 18,
         Pabaiga >= hour_rnd & Pabaiga < 10)
}

# Jeigu ir antras filtravimas nieko nerado, vadinasi pasirinkta valanda yra vìlus vakaras (22+ valanda).
if (nrow(weather_filter) == 0) {
weather_filter <- weather_final %>%
  filter(Miestas == city_rnd,
         Data == date_rnd,
         Pradzia <= hour_rnd & Pradzia >= 18,
         Pabaiga < 10)
}

weather_plot <- weather_filter %>%
  mutate(Temperatura = as.numeric(str_match(Temperatura,".\\d{1,2}"))) %>%
  ggplot() +
  geom_point(mapping = aes(Data, Temperatura), color = "blue", size = 2) +
  theme_minimal()

# NUO ÈIA NEBESIKARTOJA KODAS.
# Atrenka atitikamus Èiurlionio stoties duomenis.
weather_ciurlionis_filtered <- weather_ciurlionis %>%
  filter(Date == date_rnd,
         Hour == hour_rnd)

# Prideda nauj± informacij± prie seno grafiko.
weather_plot + geom_point(data = weather_ciurlionis_filtered, mapping = aes(Date, Temp), color = "red", shape = 1, size = 3)
  

```

